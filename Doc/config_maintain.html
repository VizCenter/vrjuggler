<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!-- $Id$ -->

<HEAD>
<TITLE>Maintaining and updating configure.in and Makefile.in</TITLE>
</HEAD>

<BODY BGCOLOR="#ffffff">

<DIV ALIGN="CENTER">
<H1>Working with <TT>configure.in</TT> and <TT>Makefile.in</TT></H1>
</DIV>

<HR WIDTH="80%" NOSHADE>

<H2>Basics</H2>

<DL>
  <DT><B>Comments in <TT>configure.in</TT></B>
    <DD>
      <P>

      Two types of comments can be used in <TT>configure.in</TT>.  The first
      is the relatively standard ``<TT>#</TT>'' comment.  Lines beginning
      with this character are copied into the final <I>configure</I> script
      generated by <I>autoconf</I>(1).  The other type is the <I>m4</I>(1)
      comment.  Lines commented in this way begin with ``<TT>dnl</TT>'' and
      are <I>not</I> copied into the <I>configure</I> script.

      <P>
  <DT><B>Language used in <TT>configure.in</TT></B>
    <DD>
      <P>

      The scripting language used in <TT>configure.in</TT> is <I>sh</I>(1).
      All conditional statements must use the form:

<PRE>
  if test "$some_var" = "some_val" ; then
      ...
  fi
</PRE>

      rather than:

<PRE>
  if [ "$some_var" = "some_val" ] ; then
      ...
  fi
</PRE>

      The brackets are recognized as special characters by <I>m4</I>(1) and
      may not be copied into <I>configure</I> properly.

      <P>
  <DT><B>Variable naming</B>
    <DD>
      <P>

      When naming variables in <TT>configure.in</TT>, be sure to follow the
      following conventions:

      <P>

      <UL>
	<LI>Names for variables that will be set externally (primarily by
	    command-line options such as <TT>--enable-debug</TT>) and not
	    substituted into generated files at the end of execution are
	    named in all lower-case letters.  All other variables are named
	    in all upper-case letters.
	<LI>Variables that are not substituted into generated files at the
	    end of the <TT>configure</TT> script's execution begin with an
	    underscore (`<TT>_</TT>') to imply that they are internal to the
	    script.  When referring to these variables, enclose the name in
	    curly braces to fully clarify it.  For example:

<PRE>
  _SOME_INTERNAL_VAR='Some value'

  [...]

  if test [ "${_SOME_INTERNAL_VAR}" = "Some value" ; then
      [...]
  fi
</PRE>
	<LI>Variables used to preserve an existing variable's value in case
	    it should need to be reset are named and used as follows:

<PRE>
  _vjsave_<I>VARIABLE</I>="$<I>VARIABLE</I>"

  [...]

  if test <B>Old value needs to be restored</B> ; then
      $<I>VARIABLE</I>="$_vjsave_<I>VARIABLE</I>"
  fi
</PRE>
      </UL>

      <P>
  <DT><B>Multi-line parameters to Autoconf macros</B>
    <DD>
      <P>

      Parameters spanning multiple lines may be passed to Autoconf macros
      without using backslashes through a special block recognized by
      <I>m4</I>(1).  Simply enclose the parameter in <TT>[]</TT>'s and it
      will be parsed as one parameter.  Remember to be careful about the use
      of semi-colons for separating <I>sh</I>(1) statements within these
      blocks.

      <P>
  <DT><B>Custom preprocessor information</B>
    <DD>
      <P>

      Anything that defines preprocessor macros other than those generated
      by the Autoconf macros must be defined in <TT>acconfig.h</TT>.  If they
      are not defined in this file, <I>autoheader</I>(1) will complain as it
      parses <TT>configure.in</TT> and finds these customizations.  Follow
      the existing syntax and layout of <TT>acconfig.h</TT> when making
      additions to it.  In general, additions only have to be made when a new
      <I>AC_DEFINE</I>, <I>AC_CHECK_TYPE</I>, etc. line is added to
      <TT>configure.in</TT>.

      <P>
  <DT><B>Including a common, external <TT>Makefile</TT></B>
    <DD>
      <P>

      Due to inconsistencies in the way various operating systems implement
      some sort of ``include'' directive in their <I>make</I>(1), there is no
      easy method for including a common, external <TT>Makefile</TT>
      containing variable assignments common to all <TT>Makefile</TT>s in the
      source tree such that it would be platform independent.  To solve this
      problem, GNU's version of <I>make</I>(1) is used for compiling VR
      Juggler.
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<H2>Layout of <TT>configure.in</TT></H2>

<DL>
  <DT><B>Initialization</B>
    <DD>
      <P>

      The first short block of <TT>configure.in</TT> performs some very basic
      initialization tasks.  The RCS revision number of the script is
      maintained here so that the user can verify that s/he has the most
      recent version of the actual <I>configure</I> script.  A check for one
      file in the source tree is also made to perform a very general, inexact
      verification that things are where they are supposed to be.  Currently,
      <I>configure</I> will check for the existence of
      <TT>Config/vjChunkDesc.cpp</TT>.  Finally, the header file created when
      done with the configuration process is named.  This file is called
      <TT>vjDefines.h</TT>.

      <P>
  <DT><B>Custom arguments</B>
    <DD>
      <P>

      In this block, the custom arguments for the <I>configure</I> script are
      defined.  The first set defines the
      <TT>--with-<I>package</I>[=<I>arg</I>]</TT> and
      <TT>--without-<I>package</I></TT> arguments.  These are intended to be
      used for choosing some external software package to use at compile
      time.  They are also used for providing a small level of customization
      to how the external software is found and/or used.

      <P>

      The second set define the <TT>--enable-<I>feature</I>[=<I>arg</I>]</TT>
      and <TT>--disable-<I>feature</I></TT> arguments that allow the user
      to choose which optional features can be built.  From the
      <A HREF="http://www.icemt.iastate.edu/~patrick/autoconf/">Autoconf 2.12
      documentation</A>, ``These options should never make a feature behave
      differently or cause one feature to replace another.''

      <P>

      For both sets of options, the <I>AC_ARG_WITH</I> and
      <I>AC_ARG_ENABLE</I> macros behave the same way.  The first argument is
      the package/feature, the second is the description printed when the
      user runs <I>configure</I> with the ``<TT>--help</TT>'' option.  The
      third argument sets a user-defined variable in the script to the
      contents of <TT>$withval</TT> or <TT>$enableval</TT> respectively.  If
      no argument is given (e.g., the user specified
      ``<TT>--enable-opengl</TT>''), the variable will get either ``yes'' or
      ``no'' as its value depending upon whether the user used the positive
      or negative form of the argument.

      <P>

      After the custom arguments are defined, some of the values that may be
      read are processed.  In particular, the application binary interface
      (ABI) under which VR Juggler will be compiled is defined.  This is
      done prior to the system-dependent section to reduce duplicated code
      even though the ABI is highly dependent upon the operating system and
      underlying computer architecture.

      <P>
  <DT><B>System-dependent setup</B>
    <DD>
      <P>

      Here, a common set of script variables are given values that are
      usually dependent upon the system on which the script is being run.
      The new variables used are all set to have no value before the
      conditional <TT>case</TT> block begins.  The subsequent conditional
      block compares the value in <TT>$host</TT> (obtained from the
      <I>AC_CANONICAL_HOST</I> macro) with known systems and sets values for
      the variables appropriately.

      <P>

      Some existing variables are modified here as well.  These include
      <TT>$CFLAGS</TT>, <TT>$CXXFLAGS</TT> and <TT>$INCLUDES</TT>.  Each of
      these could have been set as part of the user's environment variables
      or previously in the script as part of executing a macro.  Thus, they
      should be treated carefully so as not to destroy any existing values
      that may be stored in them.

      <P>

      Besides setting values in variables, custom pre-processor macros are
      defined here using the <I>AC_DEFINE</I> macro.  This macro takes two
      parameters:

      <P>

      <OL>
	<LI>The name of the macro to define.
	<LI>The value to which the macro is set by the pre-processor.
      </OL>

      <P>

      To do something similar to:

<PRE>
  #define VJ_DEF
</PRE>

      use the following syntax:

<PRE>
  AC_DEFINE(VJ_DEF,)
</PRE>

      Defining macros that take parameters cannot be done with
      <I>AC_DEFINE</I>.  However, based on a check made for something (such
      as <I>sginap</I>(2)), such a macro can be defined at the bottom of
      <TT>acconfig.h</TT>.  Refer to this file to see how a macro for
      <I>sginap</I>() is defined using <I>usleep</I>(2) in this manner.

      <P>
  <DT><B>External program checks</B>
    <DD>
      <P>

      This block is for standard program checks that <I>configure</I> does
      to ensure that software needed for compiling the package works.  Using
      the values in several preset variables (including <TT>$CC</TT> for the
      C compiler and <TT>$CXX</TT> for the C++ compiler), it runs tests on
      the software and reports any problems it finds.

      <P>
  <DT><B>External library checks</B>
    <DD>
      <P>

      Checks for needed external libraries are made here.  In this
      <I>configure</I> script, a great deal of processing is done in order
      to ensure that the source can be properly compiled and linked using
      certain external libraries.  The basic process of checking for a
      library (say, the OpenGL library) involves first checking to see if
      the library can be linked, and if so, a check is then made for a
      standard header file associated with the library (in this case,
      <TT>GL/gl.h</TT>).  In some cases, if a library cannot be found, a
      fallback check is provided.  In the case of the POSIX threads library,
      an attempt to link against <TT>libpthread</TT> is made.  If that fails
      (as it will on HP-UX 10.20), a check is made to link against
      <TT>libcma</TT>.

      <P>

      Upon successfully finding a library and a needed header file, several
      variables are usually set that are used later in the Makefile
      generation phase.  If a library is not found, the script may simply
      issue a warning about the problem or it may exit altogether if the
      library's existence is crucial to the compiling process.

      <P>

      Adding new library checks can be complicated.  The best method is to
      refer to the
      <A HREF="http://www.icemt.iastate.edu/~patrick/autoconf/">Autoconf 2.12
      documentation</A> and the existing checks.  All follow basically the
      same structure.

      <P>
  <DT><B>Header file checks</B>
    <DD>
      <P>

      Checks for standard header files and user-specified header files are
      made here.  The user-specified list is a space-separated list of
      header files that may not exist on all systems.  If a header file is
      found, <TT>HAVE_<I>FILENAME</I>_H</TT> is defined in
      <TT>vjDefines.h</TT> when it is generated.

      <P>
  <DT><B><TT>typedef</TT>, <TT>struct</TT> and compiler characteristic
      checks</B>
    <DD>
      <P>

      Here, checks are made to determine if the host system has various
      types and structures defined or not.  There are a few existing macros
      that check for specific examples of these, and it is possible to have
      user-defined checks.  Currently, little is done in this block, and in
      fact the only user-specified check is to see if the host system has
      <TT>u_int</TT> defined.  If not, it defines it (via the preprocessor,
      not <TT><B>typedef</B></TT>) to be <TT>unsigned int</TT> through the
      <I>AC_CHECK_TYPE</I> macro.  To check for <TT>struct</TT>s, use
      <I>AC_TRY_COMPILE</I> or <I>AC_EGREP_CPP</I>.  Refer to the Autoconf
      2.12 documentation section titled
      ``<A HREF="http://www.icemt.iastate.edu/~patrick/autoconf/autoconf_4.html#SEC21">Existing
      Tests</A>'' for more detailed information.

      <P>
  <DT><B>Library function checks</B>
    <DD>
      <P>

      Here, checks are made for any library and system functions (e.g.,
      <I>gettimeofday</I>(2), <I>socket</I>(2), <I>sginap</I>(2)) that may
      not exist on all systems.  As with other sections, the user-specified
      list of functions to check is the space-separated parameter passed to
      the <I>AC_CHECK_FUNCS</I> macro.  If found, <TT>HAVE_<I>FUNCNAME</I></TT>
      will be defined in <TT>vjDefines.h</TT>.

      <P>
  <DT><B>Makefile substitution</B>
    <DD>
      <P>

      Within this block of <TT>configure.in</TT>, special symbols in the
      <TT>Makefile.in</TT> files are slated for replacement with variable
      values.  This is done through the <I>AC_SUBST</I> macro, and it simply
      replaces a ``tag'' in a <TT>Makefile.in</TT> with the value stored in
      the corresponding <I>configure</I> script variable.  The following
      example illustrates what happens during the file generation phase
      (discussed next).

      Say that some <TT>Makefile.in</TT> contains the following line:

<PRE>
  CUSTOM_VAR = @CUSTOM_VAR@
</PRE>

      The string enclosed by <TT>@</TT>'s is the tag that will be replaced
      when <TT>Makefile</TT> is generated.  In <TT>configure.in</TT>, there
      following line must be present:

<PRE>
  AC_SUBST(CUSTOM_VAR)
</PRE>

      Note that the variable is not prepended by a `<TT>$</TT>' because
      variable interpolation should not be done here.  Of course,
      <TT>$CUSTOM_VAR</TT> will generally have had some value set prior to
      this point.  That is not required however.

      <P>

      It is in this phase of configuration that most of the system-dependent
      build work is done.  This is similar to what Imake template files do.
      Virtually everything preceding this point set variables to have values
      appropriate to the host machine, and now they are put into the
      <TT>Makefile</TT>s to be used for compiling the code.  There are
      several pre-defined variables that <I>configure</I> will substitute in
      the input template files.  Refer to the section titled
      ``<A HREF="http://www.icemt.iastate.edu/~patrick/autoconf/autoconf_3.html#SEC12">Preset
      Output Variables</A>'' in the Autuconf 2.12 documentation for a list
      of these.

      <P>
  <DT><B>File generation</B>
    <DD>
      <P>

      In this last block, file generation is performed using the
      <I>AC_OUTPUT</I> macro.  It iterates through its space-separated list
      of files and finds the associated <TT>.in</TT> template file.  In
      general, this step is only used for generating Makefiles
      (<TT>vjDefines.h</TT> is defined automatically due to the
      <I>AC_CONFIG_HEADER</I> call at the top of <TT>configure.in</TT>).
      When a new directory and corresponding <TT>Makefile.in</TT> are added
      to the source tree, an entry for it must be added to this list.
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<H2>Global Files for <I>make</I>(1)</H2>

<DL>
  <DT><B><TT>mk/*.mk</TT> files</B>
    <DD>
      <P>

      These files provide (typically) simple targets that may be included
      by other <TT>Makefile</TT>s.  The available files are:

      <P>

      <UL>
	<LI><B><TT>vj.clean.mk</TT></B>: This provides a `<TT>clean</TT>'
	    target.  The including file should add files to the variable
	    <TT>${CLEAN_FILES}</TT> using the <TT>+=</TT> assignment
	    operator.  For example,

<PRE>
  CLEAN_FILES += file1.o file2.o
</PRE>

	    The <TT>+=</TT> operator is used because a default value for
	    <TT>${CLEAN_FILES}</TT> is defined in this file, and thus the
	    addition of files to the list should be done <I>after</I>
	    including <TT>vj.clean.mk</TT>.

	    <P>

	    The including file may also have a local target for doing
	    specialized cleanup.  To do this, set the variable
	    <TT>${_LOCAL_CLEAN}</TT> to some dummy value <I>before</I>
	    including <TT>vj.clean.mk</TT>.  Then make a target in the
	    including <TT>Makefile</TT> called `<TT>_clean</TT>' that suits
	    the meets the given requirements for cleaning up.

	    <P>

	    <B>NOTE</B>: This file is included by the top-level file
	    <TT>Makefile.base</TT> and thus should not be directly included
	    by any files that include <TT>Makefile.base</TT>.
	<LI><B><TT>vj.compile.mk</TT></B>: Suffix rules for compiling source
	    code are defined here.  Currently, rules are given for building
	    object files from <TT>.c</TT>, <TT>.cpp</TT> and <TT>.C</TT>
	    source files.  The file that includes this file must define
	    values for the following variables:

	    <UL>
	      <LI><TT>${OBJDIR}</TT>: Where the object file is to be built).
	      <LI><TT>${C_COMPILE}</TT>: The C compiler command line without
		  the <TT>-c</TT> or <TT>-o</TT> options.
	      <LI><TT>${CXX_COMPILE}</TT>: The C++ compiler command line again
		  without the <TT>-c</TT> or <TT>-o</TT> options).
	    </UL>

	    These variables are defined in the top-level file
	    <TT>Makefile.base</TT>.
	<LI><B><TT>vj.dep.mk</TT></B>: Targets for building source file
	    dependencies are defined here.  The targets are `<TT>depend</TT>'
	    for building the dependencies and `<TT>newdepend</TT>' for
	    rebuilding the dependencies.  Those files including this one
	    must define the following variables:

	    <UL>
	      <LI><TT>${srcdir}</TT>: The directory where the source file(s)
		  is/are located.
	      <LI><TT>${DEPENDFLAGS}</TT>: Flags to pass to
		  <I>makedepend</I>(1), the program used to generate the
		  dependencies.
	      <LI><TT>${DEPEND_EXTRAS}</TT>: Extra flags that may not be
		  recognized by <I>makedepend</I>(1) because they may be
		  specific to a given compiler.  Any recognized options will
		  be processed normally while any unrecognized options will
		  be silently ignored.  Thus, this variable could be set to
		  <TT>${CLFAGS}</TT> to allow compiler options necessary for
		  the source to compile to be passed to <I>makedepend</I>(1).
	      <LI><TT>${DEPEND_SRCS}</TT>: The list of source files to be
		  processed.
	      <LI><TT>${OBJDIR}</TT>: The directory to which the compiled
		  object file(s) will be written.
	      <LI><TT>${WORKDIR}</TT>: The working directory (not necessarily
		  where the source files are found).
	    </UL>

	    Optionally, the following variables may also be defined:

	    <UL>
	      <LI><TT>${DEPEND_DEPS}</TT>: Dependencies for the
		  `<TT>depend</TT>' target.
	      <LI><TT>${NEWDEPEND_DEPS}</TT>: Dependencies for the
		  `<TT>newdepend</TT>' target.
	    </UL>
	<LI><B><TT>vj.install.mk</TT></B>: This file adds an `<TT>install</TT>'
	    target to the including <TT>Makefile</TT>.  The file including
	    this must define the <TT>${INSTALL}</TT> variable (the path to a
	    BSD-compatible <I>install</I>(1) program).

	    <P>

	    The including <TT>Makefile</TT> has the option to specifically
	    list what files should be installed or to use the default list
	    (<TT>${srcdir}/*.h</TT>).  To provide a list, a value for the
	    variable <TT>${INSTALL_FILES}</TT> must be set.  If choosing to
	    use the default list, a value for the <TT>${srcdir}</TT> variable
	    (the directory where the source file(s) is/are located) must be
	    defined.

	    <P>

	    The including <TT>Makefile</TT> also has the option to
	    specifically list where the files should be installed or to use
	    the default location.  To specify a location, a value for the
	    variable <TT>${INSTALL_PATH}</TT> must be set.  Otherwise, to
	    use the default, a value for the variable <TT>${includedir}</TT>
	    must be set.
	<LI><B><TT>vj.lib.mk</TT></B>: Compiling of libraries, both static
	    and shared, is handled by this file.  To compile a static library,
	    the target `<TT>static-lib</TT>' is provided; to compile a shared
	    library, the target `<TT>shared-lib</TT>' is provided.  The
	    including <TT>Makefile</TT> must define the following variables:

	    <UL>
	      <LI><TT>${AR}</TT>: The path to <I>ar</I>(1) (or equivalent
		  program).
	      <LI><TT>${LD}</TT>: The path to <I>ld</I>(1) (or equivalent
		  program).
	      <LI><TT>${LDOPTS}</TT>: Extra, often platform-specific, options
		  for the linker (<TT>${LD}</TT>).
	      <LI><TT>${LIBDIR}</TT>: The directory where the library will
		  be made.
	      <LI><TT>${LIBNAME}</TT>: The name of the library to generate.
	      <LI><TT>${OBJS}</TT>: The object files to be compiled into the
		  library.
	    </UL>
	<LI><B><TT>vj.rec.mk</TT></B>: This file provides a method for
	    building recursive targets through the `<TT>recursive</TT>'
	    target.  The file including this should define the following
	    variables:

	    <UL>
	      <LI><TT>${BASE_OBJDIR}</TT>: The directory to which the object
		  file(s) is, are or will be located.
	      <LI><TT>${DIRPRFX}</TT>: The prefix directory (if any) of the
		  directories listed in <TT>${SUBDIRS}</TT>.
	      <LI><TT>${OPTIMIZER}</TT>: Optimizer flag(s) for the compiler.
	      <LI><TT>${RECTARGET}</TT>: The name of the recursive target to
		  build as it is named in the <TT>Makefile</TT>s over which
		  the recursion will be performed.
	      <LI><TT>${SUBDIRS}</TT>: The subdirectories over which the
		  recursion will be done.
	    </UL>

	    To build a recursive target, say `<TT>dbg</TT>', the following
	    call to this target will give the desired results:

<PRE>
  SUBDIRS = Src1 Src2 Src3

  dbg:
      ${MAKE} RECTARGET="$@" OPTIMIZER="-g" BASE_OBJDIR="obj/debug" recursive
</PRE>
      </UL>

      Be careful to define variables and targets at the right time with
      regard to when the <TT>.mk</TT> file is included.  Unless otherwise
      specified, this should be done <I>before</I> including the <TT>.mk</TT>
      file.

      <P>
  <DT><B><TT>Makefile.base</TT></B>
    <DD>
      <P>

      Variables that are common to most, if not all, <TT>Makefile</TT>s in
      the VR Juggler source tree are set in this file.  These include the
      installation path, paths to external programs and needed command-line
      options used for compiling, installing, etc., and the names of the
      final library binaries that will be built.  Refer to the comments at
      the head of this file for a full description of each variable defined
      here.

      <P>

      <B>NOTE</B>: The file <TT>vj.clean.mk</TT> is included in this file
      and thus any file that includes <TT>Makefile.base</TT> should set the
      `<TT>default</TT>' target <I>before</I> including it.  Also when
      including this file, use the following directive:

<PRE>
  include @topdir@/Makefile.base
</PRE>

      This will ensure that there will be no problems with the path to the
      file.

      <P>
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<H2>General Layout of a <TT>Makefile.in</TT> File</H2>

<DL>
  <DT><B>Default target to build</B>
    <DD>
      <P>

      The default target for the <TT>Makefile</TT> to be generated should be
      defined before doing anything else.  This prevents any external files
      that are included from inadvertently defining a target that would be
      implicitly defined as the default target.  In most cases, the default
      target will be `<TT>all</TT>'.

      <P>
  <DT><B>Include <TT>Makefile.base</TT></B>
    <DD>
      <P>

      The next step should be to include <TT>Makefile.base</TT> to get all of
      its variable definitions.  Some of these may be needed later in the
      execution of the including file, so it should be included as early as
      possible.  It should <I>always</I> be included using the following
      syntax for the path:

<PRE>
  include @topdir@/Makefile.base
</PRE>

      This will ensure that the path is specified correctly when the actual
      <TT>Makefile</TT> is generated.  Once <TT>Makefile.base</TT> is
      included, <TT>${MKPATH}</TT> can be used for including files in the
      <TT>juggler/mk</TT> directory of the source tree.  Refer to the
      previous section's information about <TT>Makefile.base</TT> for more
      information about it.

      <P>
  <DT><B>Preset variables and variables local to the current file</B>
    <DD>
      <P>

      The first set of assignments is for preset variables (that is, those
      that are substituted by <I>configure</I> when the <TT>Makefile</TT> is
      generated) and for variables that are closely related to the preset
      variety.  In general, many of these variables will have values that are
      specific to the current <TT>Makefile</TT> being generated.  In other
      words, they cannot be shared via a common file that would be included
      by the current <TT>Makefile</TT>.

      <P>
  <DT><B>Include any <TT>.mk</TT> files needed</B>
    <DD>
      <P>

      Once all the variables are defined, this is a good time to include any
      of the <TT>.mk</TT> files that this file will need.  The path to these
      files can be extracted from the variable <TT>${MKPATH}</TT> that is
      defined in <TT>Makefile.base</TT>.  Typically, these will be the files
      needed for compiling, generating dependencies and installing.  Refer
      to the previous section's information about these files for detailed
      information.

      <P>
  <DT><B>Finding source files using <TT>vpath</TT></B>
    <DD>
      <P>

      <TT>vpath</TT> is a special directive that tells GNU <I>make</I>(1)
      where to find dependencies for object files when the source is in
      another directory.  This allows easy compiling of common source for
      multiple platforms independently.  This should be initialized as
      follows:

<PRE>
  vpath
  vpath %.c @srcdir@
  vpath %.cpp @srcdir@
  vpath %.o ${OBJDIR}
</PRE>

      The above example is (obviously) for <TT>.c</TT>, <TT>.cpp</TT> and
      <TT>.o</TT> files.  For other extensions, change the settings
      appropriately.  The <TT>${OBJDIR}</TT> variable is set in
      <TT>Makefile.base</TT>.  Refer to the previous section's description
      of <TT>Makefile.base</TT> for more information about that file.

      <P>
  <DT><B>Listing source files</B>
    <DD>
      <P>

      The list of source files that <I>makedepend</I>(1) will parse and 
      what will actually be compiled are listed next.  These file names
      should not have any path prepended to them because this will interfere
      with the output from <I>makedepend</I>(1).  When the `<TT>depend</TT>'
      target is built, it knows which directory contains the files to parse
      from the <TT>${srcdir}</TT> variable.

      <P>

      The easiest way to handle listing the files is to use the
      <TT>${DEPEND_SRCS}</TT> variable (required by <TT>vj.dep.mk</TT>) and
      then use the following GNU <I>make</I>(1) macro to convert this list
      into a list of object files to create:

<PRE>
  DEPEND_SRCS	:= src1.cpp	\
		   src2.cpp	\
		   src3.cpp

  OBJECTS	:= ${addprefix ${OBJDIR}/,${DEPEND_SRCS:.cpp=.o}}
</PRE>

      In some cases, some files may be conditionally compiled depending on
      the results of running the <I>configure</I> script.  To add these source
      files to <TT>${DEPEND_SRCS}</TT>, insert something similar to the
      following before making the list of object files:

<PRE>
  ifeq (@SOME_VAR@, "TRUE")
      DEPEND_SRCS	+= extra_src.cpp
  endif
</PRE>

      <P>
  <DT><B>Miscellaneous variables</B>
    <DD>
      <P>

      Depending on which <TT>Makefile.in</TT> is being examined, any extra
      variables needed are set here.  For example, in the top-level
      <TT>Makefile.in</TT>, the variables for the common build directory are
      set.  For the most part, everything set here is local to the current
      file.

      <P>

      One special variable set in the top-level <TT>Makefile.in</TT> is
      <TT>${SUBDIRS}</TT>.  This is the list of all subdirectories of the
      top source tree directory where compiling needs to be done.  It is used
      in doing recursive calls to <I>make</I>(1).  These recursive calls to
      <I>make</I>(1) are handled wherever other subdirectories exist--not
      just at the top level.  Presently, the other locations where similar
      code exists are in the <TT>Input</TT>, <TT>test</TT> and
      <TT>test/ogl</TT> directories.

      <P>
  <DT><B>Library targets</B>
    <DD>
      <P>

      This is where the bulk of the work is done in compiling the library.
      In the case where recursion into subdirectories is not needed, the
      following is sufficient to compile all the object files in the list
      defined above (named <TT>${OBJECTS}</TT> in the previous example):

<PRE>
  all dbg opt dso ddso obj: ${OBJECTS}
</PRE>

      Everything else is handled by the included code from
      <TT>vj.compile.mk</TT>.

      <P>

      When recursion into subdirectories is needed, things get more
      complicated.  Since it is currently unlikely that recursion will be
      needed, it will not be discussed here.  Please refer to the files
      listed at the end of this section as starting points for examples on
      how to do this.  Also refer to the information about <TT>vj.rec.mk</TT>
      given above in the section describing the <TT>.mk</TT> files.

      <P>
  <DT><B>Local targets</B>
    <DD>
      <P>

      These targets are for any source files that are not compiled into the
      library but are (for example) used as test code.  This is one example
      of a time when it may be convenient to compile code in the current
      directory rather than in a common object file directory.  Generally,
      these targets will be similar to the library targets; however,
      <I>makedepend</I>(1) is not run on these files.  A local target for
      doing this could be defined if so desired.  Presently, none of the
      <TT>Makefile</TT>s in the source tree have local targets of this form.
      The test programs are all located under the <TT>test</TT> tree.

      <P>
  <DT><B>Clean-up targets</B>
    <DD>
      <P>

      The standard `<TT>clean</TT>' target is described above in the
      discussion about <TT>vj.clean.mk</TT>.  For localized clean-up, follow
      the instructions given there for the `<TT>_clean</TT>' target.  This
      can be defined to have whatever functionality is needed.

      <P>
  <DT><B>Dependencies</B>
    <DD>
      <P>

      Most <TT>Makefile.in</TT> files end with an area where all the source
      dependencies are appended when the standard `<TT>depend</TT>' and
      `<TT>newdepend</TT>' targets are built.  The line marking this
      section must remain intact so that <I>makedepend</I>(1) will know where
      it is safe to begin overwriting the dependencies should it be run
      again.  This line is:

<PRE>
  # DO NOT DELETE THIS LINE -- make depend depends on it.
</PRE>

      It is the default string recognized by <I>makedepend</I>(1), but it can
      be changed by specifying an alternate string as an argument to
      <I>makedepend</I>(1).

      <P>
  <DT><B>Examples for use as starting points</B>
    <DD>
      <P>

      When a new <TT>Makefile.in</TT> needs to be added, the best place to
      start is an existing <TT>Makefile.in</TT>.  Currently, there are
      several different types to use as starting points.  Depending on your
      needs, look to the following files:

      <P>

      <UL>
	<LI><B><TT>Config/Makefile.in</TT></B>: This is the most basic type
	    of <TT>Makefile.in</TT>.  It needs no recursive build capabilities
	    and simply compiles the source files listed using the global
	    definitions described above.
	<LI><B><TT>Input/Makefile.in</TT></B>: This is the simplest example
	    of the use of recursive building with no source code to compile
	    in the current directory.  It includes code for doing recursive
	    building, cleaning, installing and generating of dependencies.
	<LI><B><TT>Kernel/Makefile.in</TT></B>: This file combines the
	    capabilities of the previous two as it has to both compile code
	    in the <TT>Kernel</TT> directory and compile code in
	    subdirectories recursively.  Recursive installation and
	    dependency generation are handled differently in this file than
	    in <TT>Input/Makefile.in</TT> because these actions must be
	    performed on files in the current directory as well as in
	    subdirectories.
	<LI><B><TT>test/ogl/cubes/Makefile.in</TT></B>: This file is basically
	    all that is needed to compile a specific VR Juggler test program.
	    Copy it and modify it as needed.  That is all it takes.  For
	    programs that test aspects of VR Juggler that do not require
	    VR Juggler windows, look at <TT>test/CfgTest/Makefile.in</TT>.
	    Both of these files are very simple (with the second being the
	    simpler of the two), and that is the goal of the test code
	    <TT>Makefile</TT>s since they will actually be used by end users.
	<LI><B><TT>test/Makefile.in</TT></B>: Finally, a very simple example
	    of recursively building test programs can be found here.  As with
	    the previous file, simplicity is the main goal with this kind of
	    <TT>Makefile.in</TT>.
      </UL>
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<H2>References</H2>

<DL>
  <DT><B>GNU Autoconf 2.12 Documentation</B>
    <DD>
      <P>

      The documentation comes with the Autoconf distribution and can be
      converted into HTML format.  It is very comprehensive but also very
      long.  On the ICEMT SGI workstations, the <TT>autoconf.info</TT> file
      is located in <TT>/usr/local/info</TT>.  The documentation in
      <A HREF="http://www.icemt.iastate.edu/~patrick/autoconf/">HTML
      format</A> is in available online.
</DL>

<HR WIDTH="80%" NOSHADE>
<P>

<FONT SIZE="-1">
<B>Last modified:</B> $Date$<BR>
<B>Written by:</B> Patrick Hartling
&lt;<I><A HREF="mailto:patrick@icemt.iastate.edu">patrick@icemt.iastate.edu</A></I>&gt;<BR>
</FONT>

</BODY>
